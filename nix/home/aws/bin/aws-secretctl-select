#!/usr/bin/env bash
set -euo pipefail

export AWS_PAGER=""

usage() {
  cat <<EOF
Usage: aws-secretctl-select [OPTIONS] [GUM_OPTIONS...]

Interactively select a secret.

Options:
  --arn          Return ARN instead of name
  --query TEXT   Prepopulate filter with search query
  -h, --help     Show this help message

Any additional options are passed through to gum filter.
Common gum options: --limit N, --no-limit, --placeholder TEXT

Examples:
  aws-secretctl-select
  aws-secretctl-select --arn
  aws-secretctl-select --query "prod"
  aws-secretctl-select --limit 1
  aws-secretctl-select --arn --limit 5
EOF
}

field="Name"
gum_args=()
query=""

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
  -h | --help)
    usage
    exit 0
    ;;
  --arn)
    field="ARN"
    shift
    ;;
  --query)
    if [[ $# -lt 2 ]]; then
      echo >&2 "Error: --query requires a value"
      exit 1
    fi
    query="$2"
    shift 2
    ;;
  *)
    gum_args+=("$1")
    shift
    ;;
  esac
done

# Add query as --value for gum filter if provided
if [[ -n "$query" ]]; then
  gum_args+=(--value "$query")
fi

aws secretsmanager list-secrets --query "SecretList[].[$field]" --output text | gum filter "${gum_args[@]}"
