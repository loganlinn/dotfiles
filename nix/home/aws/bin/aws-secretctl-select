#!/usr/bin/env bash
set -euo pipefail

export AWS_PAGER=""

usage() {
  cat <<EOF
Usage: aws-secretctl-select [OPTIONS] [GUM_OPTIONS...]

Interactively select a secret from Secrets Manager or SSM Parameter Store.

Options:
  --arn          Return ARN instead of name
  --ssm          Select from SSM parameters instead of secrets
  --path PATH    Filter SSM parameters by path prefix (requires --ssm)
  --query TEXT   Prepopulate filter with search query
  -h, --help     Show this help message

Any additional options are passed through to gum filter.
Common gum options: --limit N, --no-limit, --placeholder TEXT

Examples:
  aws-secretctl-select
  aws-secretctl-select --arn
  aws-secretctl-select --ssm
  aws-secretctl-select --ssm --path /prod/db/
  aws-secretctl-select --query "prod"
  aws-secretctl-select --limit 1
  aws-secretctl-select --arn --limit 5
EOF
}

backend="secretsmanager"
field="Name"
gum_args=()
query=""
path_filter=""

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
  -h | --help)
    usage
    exit 0
    ;;
  --ssm)
    backend="ssm"
    shift
    ;;
  --arn)
    field="ARN"
    shift
    ;;
  --path)
    if [[ $# -lt 2 ]]; then
      echo >&2 "Error: --path requires a value"
      exit 1
    fi
    path_filter="$2"
    shift 2
    ;;
  --query)
    if [[ $# -lt 2 ]]; then
      echo >&2 "Error: --query requires a value"
      exit 1
    fi
    query="$2"
    shift 2
    ;;
  *)
    gum_args+=("$1")
    shift
    ;;
  esac
done

# Validate --path only with --ssm
if [[ -n "$path_filter" && "$backend" != "ssm" ]]; then
  echo >&2 "Error: --path can only be used with --ssm"
  exit 1
fi

# Add query as --value for gum filter if provided
if [[ -n "$query" ]]; then
  gum_args+=(--value "$query")
fi

# List and filter based on backend
if [[ "$backend" == "ssm" ]]; then
  # Build SSM parameter filters
  ssm_args=()
  if [[ -n "$path_filter" ]]; then
    ssm_args+=(--parameter-filters "Key=Path,Option=Recursive,Values=$path_filter")
  fi

  # SSM uses different query path
  if [[ "$field" == "ARN" ]]; then
    aws ssm describe-parameters "${ssm_args[@]}" --query 'Parameters[].[ARN]' --output text | gum filter "${gum_args[@]}"
  else
    aws ssm describe-parameters "${ssm_args[@]}" --query 'Parameters[].[Name]' --output text | gum filter "${gum_args[@]}"
  fi
else
  # Secrets Manager
  aws secretsmanager list-secrets --query "SecretList[].[$field]" --output text | gum filter "${gum_args[@]}"
fi
