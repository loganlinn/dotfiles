#!/usr/bin/env bash
set -euo pipefail

export AWS_PAGER=""

usage() {
  cat <<EOF
Usage: aws-secretctl-get [OPTIONS] [SECRET...]

Get the value of one or more secrets.

Arguments:
  SECRET...     One or more secrets (name or ARN). If not provided, interactive selector is shown.

Options:
  -h, --help    Show this help message

If multiple secrets are provided, each value will be retrieved.
EOF
}

secret_ids=()

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
  -h | --help)
    usage
    exit 0
    ;;
  -*)
    echo >&2 "Unknown option: $1"
    usage >&2
    exit 1
    ;;
  *)
    secret_ids+=("$1")
    shift
    ;;
  esac
done

# Select secret if none provided
if [[ ${#secret_ids[@]} -eq 0 ]]; then
  secret_ids=("$(aws-secretctl-select --limit 1)") || exit $?
  if [[ -z "${secret_ids[0]}" ]]; then
    echo >&2 "No secret selected"
    exit 1
  fi
fi

# Process each secret, falling back to interactive select on error
for secret_id in "${secret_ids[@]}"; do
  if ! aws secretsmanager get-secret-value --secret-id "$secret_id" --query SecretString --output text 2>/dev/null; then
    echo >&2 "Secret '$secret_id' not found, searching..."
    resolved_id="$(aws-secretctl-select --limit 1 --query "$secret_id")" || exit $?
    if [[ -z "$resolved_id" ]]; then
      echo >&2 "No secret selected"
      exit 1
    fi
    aws secretsmanager get-secret-value --secret-id "$resolved_id" --query SecretString --output text
  fi
done
