#!/usr/bin/env bash
set -euo pipefail

export AWS_PAGER=""

usage() {
  cat <<EOF
Usage: aws-secretctl-edit [OPTIONS] [SECRET]

Edit a secret using vipe.

Arguments:
  SECRET       Secret (name or ARN). If not provided, interactive selector is shown.

Options:
  -h, --help   Show this help message

The secret value will be opened in vi (without plugins) for editing.
After editing, you can choose to update, delete, or cancel the operation.
EOF
}

secret_id=""

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
  -h | --help)
    usage
    exit 0
    ;;
  -*)
    echo >&2 "Unknown option: $1"
    usage >&2
    exit 1
    ;;
  *)
    if [[ -n "$secret_id" ]]; then
      echo >&2 "Error: multiple secret IDs provided"
      usage >&2
      exit 1
    fi
    secret_id="$1"
    shift
    ;;
  esac
done

# Select secret if not provided
if [[ -z "$secret_id" ]]; then
  secret_id="$(aws-secretctl-select --limit 1)" || exit $?
  if [[ -z "$secret_id" ]]; then
    echo >&2 "No secret selected"
    exit 1
  fi
fi

# Get current secret value, fallback to interactive select on error
if ! current_value="$(aws secretsmanager get-secret-value --secret-id "$secret_id" --query SecretString --output text 2>/dev/null)"; then
  echo >&2 "Secret '$secret_id' not found, searching..."
  secret_id="$(aws-secretctl-select --limit 1 --query "$secret_id")" || exit $?
  if [[ -z "$secret_id" ]]; then
    echo >&2 "No secret selected"
    exit 1
  fi
  current_value="$(aws secretsmanager get-secret-value --secret-id "$secret_id" --query SecretString --output text)"
fi

# Edit with vipe using vi without plugins
new_value="$(echo "$current_value" | EDITOR="vi -u NONE -n" vipe)"

# Check if value changed
if [[ "$current_value" == "$new_value" ]]; then
  echo >&2 "No changes made"
  exit 0
fi

# Determine action based on whether input is empty
if [[ -z "$new_value" ]]; then
  action="$(echo -e "Delete\nCancel" | gum choose --header "Empty input. Delete secret '$secret_id'?")" || exit $?
else
  action="$(echo -e "Update\nDelete\nCancel" | gum choose --header "Action for secret '$secret_id'?")" || exit $?
fi

case "$action" in
Update)
  if ! aws secretsmanager put-secret-value \
    --secret-id "$secret_id" \
    --secret-string "$new_value" 2>/dev/null; then
    echo >&2 "Failed to update secret"
    exit 1
  fi
  echo >&2 "Secret updated successfully"
  ;;
Delete)
  aws-secretctl-delete "$secret_id" || exit $?
  ;;
Cancel | "")
  echo >&2 "Operation cancelled"
  exit 1
  ;;
esac
