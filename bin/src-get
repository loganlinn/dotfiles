#!/usr/bin/env bash

[[ $TRACE ]] && set -x
set -eo pipefail

require() { hash "$@" || exit 127; }

require git

SRC_HOME=${SRC_HOME:-$HOME/src}
GIT_PROTOCOL_DEFAULT=https
GIT_HOSTNAME_DEFAULT=github.com
GIT_CLONE_OPTS=(
  --recurse-submodules 
)

resolve_repo_url() {
	local input=$1

	if [[ $input == - ]]; then
		input=$(</dev/stdin)
	fi

	case "$input" in

  # https://github.com/loganlinn/dotfiles
	*://*)
		printf "%s" "$input"
		;;

  # github.com/loganlinn/dotfiles
	*.*/*)
		printf "%s://%s" "$GIT_PROTOCOL_DEFAULT" "$input"
		;;

  # loganlinn/dotfiles
	*/*)
		printf "%s://%s/%s" "$GIT_PROTOCOL_DEFAULT" "$GIT_HOSTNAME_DEFAULT" "$input"
		;;

  # loganlinn
  *)
    input=$(gh repo list "$input" | fzf | cut -f1)
		printf "%s://%s/%s" "$GIT_PROTOCOL_DEFAULT" "$GIT_HOSTNAME_DEFAULT" "$input"
    ;;

	esac
}

main() {
  local url
  local path

  for repo; do
    url=$(resolve_repo_url "$repo")

    # strip protocol and extension
    path=$SRC_HOME/${url#*://}
    path=${path%%.git}

    git clone "${GIT_CLONE_OPTS[@]}" -- "$url" "$path"
  done
}

main "$@"
